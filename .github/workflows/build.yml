name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_url:
        description: 'Kernel GitHub URL'
        required: true
        default: 'https://github.com/Blacksmithyogi/kernel_xiaomi_courbet.git'
        type: string
      kernel_branch:
        description: 'Kernel branch'
        required: true
        default: 'A15'
        type: string
      recurse_submodule:
        description: 'Clone submodules (true/false)'
        required: true
        default: false
        type: boolean
      is_release:
        description: 'Create GitHub release (true/false)'
        required: true
        default: false
        type: boolean

jobs:
  Build-Kernel:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    env:
      KERNEL_NAME: "courbet"
      KERNEL_DIR: "courbet-kernel"
      ARCH: "arm64"
      KERNEL_URL: ${{ github.event.inputs.kernel_url }}
      KERNEL_BRANCH: ${{ github.event.inputs.kernel_branch }}
      RECURSE_SUBMODULE: ${{ github.event.inputs.recurse_submodule }}
      IS_RELEASE: ${{ github.event.inputs.is_release }}
      KERNEL_TYPE: "HyperOS"  # Add KERNEL_TYPE here

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update && sudo apt install -y \
          git bc bison flex libssl-dev make automake build-essential \
          curl zip clang lld gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

    - name: Clone kernel source
      run: |
        if [ "${{ env.RECURSE_SUBMODULE }}" = "true" ]; then
          git clone --recurse-submodules ${{ env.KERNEL_URL }} -b ${{ env.KERNEL_BRANCH }} ${{ env.KERNEL_DIR }}
        else
          git clone ${{ env.KERNEL_URL }} -b ${{ env.KERNEL_BRANCH }} ${{ env.KERNEL_DIR }}
        fi
        
    - name: Build kernel
      run: |
        cd ${{ env.KERNEL_DIR }}
        export ARCH=${{ env.ARCH }}
        make O=out ${{ env.KERNEL_NAME }}_defconfig
        make -j$(nproc --all) O=out EXTRAVERSION="" CC=clang \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          CONFIG_NO_ERROR_ON_MISMATCH=y

        
        BUILD_TIME=$(date '+%Y%m%d-%H%M%S')
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
        
        KERNEL_VERSION=$(make kernelversion)
        echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV

        mkdir ${GITHUB_WORKSPACE}/output
        cp out/arch/arm64/boot/Image.gz ${GITHUB_WORKSPACE}/output/
        cp out/arch/arm64/boot/dtb.img ${GITHUB_WORKSPACE}/output/
        cp out/arch/arm64/boot/dtbo.img ${GITHUB_WORKSPACE}/output/
        cd ${GITHUB_WORKSPACE}

    - name: Verify kernel version
      run: |
        cd ${{ env.KERNEL_DIR }}
        echo "Kernel version: $(make O=out kernelversion)"
        echo "Kernel release: $(make O=out kernelrelease)"

    - name: Package kernel (AnyKernel3)
      run: |
        git clone https://github.com/Blacksmithyogi/AnyKernel3.git -b Smirnoff
        cp output/* AnyKernel3/
        cd AnyKernel3

        # Use KERNEL_TYPE in the ZIP file name
        zip -r9 ../${{ env.KERNEL_TYPE }}-${{ env.KERNEL_BRANCH }}-${{ env.KERNEL_VERSION }}-${{ env.KERNEL_NAME }}-$BUILD_TIME.zip * -x .git README.md *placeholder
        cd ${GITHUB_WORKSPACE}

    - name: List files after packaging
      run: ls -l

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_TYPE }}-${{ env.KERNEL_VERSION }}-${{ env.KERNEL_BRANCH }}-${{ env.KERNEL_NAME }}
        path: ${{ env.KERNEL_TYPE }}-*.zip

    - name: Get latest commit hash
      id: get_hash
      run: |
        HASH=$(git -C ${{ env.KERNEL_DIR }} rev-parse --short HEAD)
        echo "HASH=$HASH" >> $GITHUB_ENV

    - name: Create release
      if: ${{ env.IS_RELEASE == 'true' }}
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: v${{ env.KERNEL_VERSION }}
        name: "Kernel Version ${{ env.KERNEL_VERSION }}"
        body: '${{ env.KERNEL_VERSION }}-${{ env.KERNEL_TYPE }}-${{ env.KERNEL_BRANCH }} for ${{ env.KERNEL_NAME }}'
        draft: false
        prerelease: false
        generate_release_notes: false
        files: ${{ env.KERNEL_TYPE }}*.zip    

    - name: Upload to Telegram
      run: |
        curl -F document=@"${{ env.KERNEL_TYPE }}-${{ env.KERNEL_BRANCH }}-${{ env.KERNEL_VERSION }}-${{ env.KERNEL_NAME }}-$env.BUILD_TIME.zip" \
             -F caption="Kernel Build Success! Version: ${{ env.KERNEL_VERSION }}, Build Time: $BUILD_TIME
             âœ… Completed in $((SECONDS / 60)) minute(s) and $((SECONDS % 60)) second(s)! 
             Latest commit: ${{ env.HASH }}" \
             https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument?chat_id=${{ secrets.TELEGRAM_CHAT_ID }}
